// Hedef Performans - Veritabanı Şeması (PostgreSQL)
// Production için PostgreSQL versiyonu
// Bu dosyayı schema.prisma olarak kopyalayın veya datasource kısmını değiştirin

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Kullanıcı tablosu - temel auth bilgileri
model User {
  id                       String   @id @default(cuid())
  email                    String   @unique
  password                 String   // bcrypt hash
  firstName                String
  lastName                 String
  phone                    String?
  isMartyrRelative         Boolean  @default(false)
  martyrRelativeDocumentUrl String?
  role                     String   @default("MEMBER") // MEMBER, ADMIN
  status                   String   @default("PENDING") // PENDING, ACTIVE, SUSPENDED
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt

  // İlişkiler
  memberProfile MemberProfile?
  parentInfo    ParentInfo?
  payments      Payment[]
  videos        Video[]
  squadAssignments SquadAssignment[]
  termsConsents TermsConsent[]

  @@map("users")
}

// Üye profil bilgileri - Kadro sistemi için güncellendi
model MemberProfile {
  id              String   @id @default(cuid())
  userId          String   @unique
  firstName       String
  lastName        String
  birthYear       Int      // Doğum yılı (2014-2018 veya 2006-2013)
  mainPositionKey String   // KALECI, SAGBEK, STOPER, ORTA_8, FORVET vb.
  altPositionKey  String?  // Yedek mevki
  country         String
  city            String
  district        String
  phone           String
  team            String?
  league          String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // İlişkiler
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("member_profiles")
}

// Ödeme tablosu
model Payment {
  id            String   @id @default(cuid())
  userId        String
  amount        Float    // 499.00 TL
  currency      String   @default("TRY")
  status        String   @default("PENDING") // PENDING, PAID, FAILED, CANCELLED
  paytrToken    String?
  paytrRefNo    String?
  paytrOrderId  String?
  failureReason String?
  paidAt        DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // İlişkiler
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("payments")
}

// Sözleşme versiyonları
model TermsVersion {
  id          String   @id @default(cuid())
  version     String   @unique
  title       String
  content     String   // Sözleşme içeriği
  isActive    Boolean  @default(false)
  createdAt   DateTime @default(now())

  // İlişkiler
  consents TermsConsent[]

  @@map("terms_versions")
}

// Kullanıcı sözleşme onayları
model TermsConsent {
  id            String   @id @default(cuid())
  userId        String
  termsVersionId String
  consentedAt   DateTime @default(now())

  // İlişkiler
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  termsVersion TermsVersion @relation(fields: [termsVersionId], references: [id])

  @@unique([userId, termsVersionId])
  @@map("terms_consents")
}

// Üye videoları
model Video {
  id          String   @id @default(cuid())
  userId      String
  title       String
  description String?
  videoUrl    String
  thumbnailUrl String?
  duration    Int?
  quality     String   @default("HD_720P") // HD_720P, FHD_1080P
  viewCount   Int      @default(0)
  isPublic    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // İlişkiler
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("videos")
}

// Admin maç videoları
model AdminMatch {
  id          String   @id @default(cuid())
  title       String
  description String?
  videoUrl    String
  thumbnailUrl String?
  duration    Int?
  quality     String   @default("HD_720P")
  viewCount   Int      @default(0)
  isPublic    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("admin_matches")
}

// Kadro sistemi - Yeni yaş grubu tabanlı sistem
model Squad {
  id            String   @id @default(cuid())
  ageGroupCode  String   // U2012, U2013 vb.
  template      String   // "7+1" veya "10+1"
  instance      String   // "A", "B", "C" vb.
  name          String   // "U2012 10+1 A"
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // İlişkiler
  assignments   SquadAssignment[]
  whatsappGroup WhatsAppGroup?

  // Unique constraints
  @@unique([ageGroupCode, template, instance])
  @@map("squads")
}

// Kadro atamaları - Pozisyon ve forma numarası ile
model SquadAssignment {
  id           String   @id @default(cuid())
  squadId      String
  userId       String
  ageGroupCode String   // U2006, U2007 vb. - Performans için direkt alan
  positionKey  String   // KALECI, SAGBEK, ORTA_8 vb.
  number       Int      // Forma numarası (1, 2, 4, 6 vb.)
  assignedAt   DateTime @default(now())
  source       String   @default("AUTO") // AUTO, MANUAL

  // İlişkiler
  squad Squad @relation(fields: [squadId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Unique constraints
  @@unique([squadId, number]) // Aynı formayı iki kişi alamaz
  @@unique([userId, squadId]) // Bir kullanıcı bir kadroda sadece bir kez
  @@unique([userId, ageGroupCode]) // Bir kullanıcı aynı yaş grubunda sadece bir kez
  @@map("squad_assignments")
}

// WhatsApp grup linkleri
model WhatsAppGroup {
  id          String   @id @default(cuid())
  squadId     String   @unique
  groupName   String
  inviteLink  String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // İlişkiler
  squad Squad @relation(fields: [squadId], references: [id], onDelete: Cascade)

  @@map("whatsapp_groups")
}

// Slider öğeleri
model SliderItem {
  id        String   @id @default(cuid())
  side      String   // LEFT, RIGHT
  title     String?
  imageUrl  String
  linkUrl   String?
  sort      Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("slider_items")
}

// Site ayarları (JSON içerik)
model SiteSetting {
  key       String   @id
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("site_settings")
}

// Veli Bilgileri (Türkiye futbol federasyonu veri kayıt sistemine uygun)
model ParentInfo {
  id                    String   @id @default(cuid())
  userId                 String   @unique
  parentOccupationGroup  String?  // Veli Meslek Grubu
  parentPhone            String?  // Veli Telefon Numarası
  participationCity      String?  // Seçmelere Katılacağınız Şehir
  kvkkAccepted           Boolean  @default(false) // KVKK kapsamında işlenmesini kabul ediyorum
  infoFormAccepted       Boolean  @default(false) // Ön Bilgilendirme Formunu okudum, onaylıyorum
  healthConsentAccepted  Boolean  @default(false) // Sağlık Onam Formunu okudum, onaylıyorum
  salesContractAccepted  Boolean  @default(false) // Mesafeli Satış Sözleşmesini okudum, onaylıyorum
  playedInClubBefore     Boolean? // Daha Önce Bir Kulüpte Oynadı Mı
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  // İlişkiler
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("parent_infos")
}

